<!-- pages/common/judge-answer/questionnaire-detail.wxml -->
<view class="container">
  <!-- 加载状态 -->
  <view wx:if="{{loading}}" class="loading-container">
    <image src="/images/empty.png" class="loading-icon"></image>
    <text>加载问卷中...</text>
  </view>

  <!-- 问卷内容 -->
  <view wx:else class="questionnaire-container">
    <!-- 顶部进度条 -->
    <view class="progress-container">
      <view class="progress-bar">
        <view class="progress-active" style="{{'width:' + ((currentQuestionIndex + 1) / questionnaire.questions.length * 100) + '%;'}}"></view>
      </view>
      <text class="progress-text">{{currentQuestionIndex + 1}}/{{questionnaire.questions.length}}</text>
    </view>

    <!-- 问卷标题 -->
    <view class="questionnaire-header">
      <text class="questionnaire-title">{{questionnaire.name}}</text>
      <text class="questionnaire-desc">{{questionnaire.description}}</text>
      <view class="questionnaire-meta">
        <text>填写时间: {{questionnaire.finishedAt}}</text>
        <view class="status-badge {{questionnaire.status === '已批阅' ? 'judged' : 'unjudged'}}">
          {{questionnaire.status}}
        </view>
      </view>
    </view>

    <!-- 选题弹窗 -->
    <view class="question-selector-mask" wx:if="{{showQuestionSelector}}" bindtap="hideQuestionSelector"></view>
    <view class="question-selector" wx:if="{{showQuestionSelector}}">
      <view class="selector-title">选择题目</view>
      <view class="question-list">
        <view wx:for="{{questionnaire.questions}}" wx:key="index"
          class="popup-question-item {{index === currentQuestionIndex ? 'current' : ''}}"
          bindtap="selectQuestion" data-index="{{index}}">
          Q{{index + 1}}
        </view>
      </view>
    </view>
    
    <!-- 计算得分弹窗 -->
    <view wx:if="{{showScoreCalculator}}" class="score-popup-container" catchtouchmove="preventTouchMove">
      <view class="score-calculator-mask" bindtap="closeScoreCalculator"></view>
      <view class="score-calculator" catchtouchmove="preventTouchMove">
        <view class="calculator-title">计算得分</view>
        
        <view class="calculator-content">
          <view class="score-range-section">
          <text class="section-label">题号区间：</text>
          <view class="range-selector">
            <view class="question-input-group">
              <text>第</text>
              <input class="question-number-input"
                type="number"
                value="{{startQuestionIndex + 1}}"
                min="1"
                max="{{questionnaire.questions.length}}"
                bindinput="onStartIndexInput" />
              <text>题</text>
            </view>
            
            <text class="range-separator">至</text>
            
            <view class="question-input-group">
              <text>第</text>
              <input class="question-number-input"
                type="number"
                value="{{endQuestionIndex + 1}}"
                min="1"
                max="{{questionnaire.questions.length}}"
                bindinput="onEndIndexInput" />
              <text>题</text>
            </view>
          </view>
        </view>
          
          <!-- 确定按钮 -->
          <view class="calculate-confirm-section">
            <button class="confirm-button" bindtap="onCalculateConfirm">确定</button>
          </view>
          
          <view class="score-result-section">
            <text class="section-label">得分总和：</text>
            <text class="score-sum-value">{{scoreSum}} 分</text>
          </view>
        </view>
      
      <view class="calculator-footer">
        <button class="save-score-button" bindtap="saveScoreRange">保存得分</button>
        <button class="close-button" bindtap="closeScoreCalculator">关闭</button>
      </view>
      </view>
    </view>

    <!-- 当前题目 -->
    <view class="current-question" wx:if="{{questionnaire.questions && questionnaire.questions[currentQuestionIndex]}}">
      <view class="question-content-item">
        <view class="question-header">
          <text class="question-index">{{currentQuestionIndex + 1}}.</text>
          <text class="question-title">{{questionnaire.questions[currentQuestionIndex].title}}</text>
          <text wx:if="{{questionnaire.questions[currentQuestionIndex].required}}" class="required-mark">*</text>
        </view>
        <text wx:if="{{questionnaire.questions[currentQuestionIndex].moduleName}}" class="module-tag">所属模块：{{questionnaire.questions[currentQuestionIndex].moduleName}}</text>

        <!-- 单选题 -->
        <view wx:if="{{questionnaire.questions[currentQuestionIndex].type === 'single'}}">
          <!-- 显示上传的图片 -->
          <view wx:if="{{questionnaire.questions[currentQuestionIndex].imageUrl}}" class="example-image-container">
            <image
              src="{{questionnaire.questions[currentQuestionIndex].imageUrl}}"
              mode="aspectFit"
              class="example-image"
            />
          </view>
          <view wx:for="{{questionnaire.questions[currentQuestionIndex].options}}" wx:for-item="option" wx:for-index="optIndex" wx:key="index" class="option-item">
            <view class="option-content {{optIndex === questionnaire.questions[currentQuestionIndex].selectedOption ? 'selected' : ''}}">
              <view class="option-letter">{{letters[optIndex]}}</view>
              <text class="option-text">{{option}}</text>
            </view>
          </view>
        </view>

        <!-- 多选题 -->
        <view wx:elif="{{questionnaire.questions[currentQuestionIndex].type === 'multiple'}}">
          <!-- 显示上传的图片 -->
          <view wx:if="{{questionnaire.questions[currentQuestionIndex].imageUrl}}" class="example-image-container">
            <image
              src="{{questionnaire.questions[currentQuestionIndex].imageUrl}}"
              mode="aspectFit"
              class="example-image"
            />
          </view>
          <view wx:for="{{questionnaire.questions[currentQuestionIndex].options}}" wx:for-item="option" wx:for-index="optIndex" wx:key="index" class="option-item">
            <view class="option-content {{questionnaire.questions[currentQuestionIndex]._selectedIndexSet && questionnaire.questions[currentQuestionIndex]._selectedIndexSet[optIndex] ? 'selected' : ''}}">
              <view class="option-letter">{{letters[optIndex]}}</view>
              <text class="option-text">{{option}}</text>
            </view>
          </view>

        </view>
    <!-- 填空题 -->
        <view wx:elif="{{questionnaire.questions[currentQuestionIndex].type === 'blank'}}">
          <view class="blank-answer">
            <view wx:if="{{questionnaire.questions[currentQuestionIndex].answer}}">
              <text class="answer-label">用户答案：</text>
              <text class="answer-content">{{questionnaire.questions[currentQuestionIndex].answer}}</text>
            </view>
            <view wx:elif="{{questionnaire.questions[currentQuestionIndex].blanks && Array.isArray(questionnaire.questions[currentQuestionIndex].blanks) && questionnaire.questions[currentQuestionIndex].blanks.length > 0}}">
              <text class="answer-label">用户答案：</text>
              <text class="answer-content">{{questionnaire.questions[currentQuestionIndex].blanks.join('，')}}</text>
            </view>
            <view wx:elif="{{questionnaire.questions[currentQuestionIndex].blanks && !Array.isArray(questionnaire.questions[currentQuestionIndex].blanks)}}">
              <text class="answer-label">用户答案：</text>
              <text class="answer-content">{{questionnaire.questions[currentQuestionIndex].blanks}}</text>
            </view>
            <!-- 兼容可能存在的其他答案格式 -->
            <view wx:elif="{{questionnaire.questions[currentQuestionIndex].answerText}}">
              <text class="answer-label">用户答案：</text>
              <text class="answer-content">{{questionnaire.questions[currentQuestionIndex].answerText}}</text>
            </view>
            <view wx:else>
              <text class="answer-label">用户未填写答案</text>
            </view>
          </view>
        </view>

        <!-- 矩阵题/勾选题 -->
        <view wx:elif="{{questionnaire.questions[currentQuestionIndex].type === 'matrix'}}">
          <!-- 图片上传区域 -->
          <view class="section-header">
            <text class="section-title">题目图片</text>
          </view>
          <view class="upload-container">
            <image wx:if="{{questionnaire.questions[currentQuestionIndex].imageUrl}}" src="{{questionnaire.questions[currentQuestionIndex].imageUrl}}" mode="aspectFit" class="uploaded-image"></image>
            <view wx:else class="no-image"></view>
          </view>

          <!-- 矩阵显示区域 -->
          <view class="section-header matrix-section">
            <text class="section-title">勾选题表格</text>
          </view>
          <view class="matrix-edit-container">
            <!-- 左上角固定单元格 -->
            <view class="fixed-corner"></view>

            <!-- 列标题区域 (可横向滚动) -->
            <scroll-view class="matrix-header-scroll" scroll-x="{{true}}" scroll-left="{{scrollLeft}}">
              <view class="matrix-header">
                <view wx:for="{{questionnaire.questions[currentQuestionIndex].matrix.colHeaders}}" wx:key="col-{{index}}" class="header-cell">
                  <text>{{item}}</text>
                </view>
              </view>
            </scroll-view>

            <!-- 行标题和内容区域 (可纵向滚动) -->
            <scroll-view class="matrix-body-scroll" scroll-y="{{true}}" scroll-top="{{scrollTop}}">
              <view wx:for="{{questionnaire.questions[currentQuestionIndex].matrix.rowHeaders}}" wx:key="row-{{index}}" class="matrix-row">
                <!-- 行标题 -->
                <view class="row-header">
                  <text>{{item}}</text>
                </view>

                <!-- 单元格区域 (可横向滚动) -->
                <scroll-view class="matrix-cells-scroll" scroll-x="{{true}}" scroll-left="{{scrollLeft}}">
                  <view class="matrix-row-cells">
                    <view wx:for="{{questionnaire.questions[currentQuestionIndex].matrix.colHeaders}}" wx:for-item="colItem" wx:for-index="colIndex" wx:key="colIndex" class="matrix-cell">
                      <view class="checkbox {{questionnaire.questions[currentQuestionIndex].matrix.selectedCells && questionnaire.questions[currentQuestionIndex].matrix.selectedCells[index] && questionnaire.questions[currentQuestionIndex].matrix.selectedCells[index][colIndex] ? 'checked' : ''}}"></view>
                    </view>
                  </view>
                </scroll-view>
              </view>
            </scroll-view>
          </view>
        </view>

        <!-- 画图题 -->
        <view wx:elif="{{questionnaire.questions[currentQuestionIndex].type === 'draw'}}">
          <view class="drawing-container">
            <!-- 显示提示句 -->
            <block wx:if="{{questionnaire.questions[currentQuestionIndex].subType === 'clock'}}">
              <view class="clock-prompt-container">
                <text class="prompt-title">提示句：</text>
                <text class="prompt-content">
                  请画出{{questionnaire.questions[currentQuestionIndex].hour || 'X'}}点{{questionnaire.questions[currentQuestionIndex].timeRelation || '过'}}{{questionnaire.questions[currentQuestionIndex].minute || 'X'}}分
                </text>
                <view class="prompt-options">
                  <text wx:if="{{questionnaire.questions[currentQuestionIndex].showOutline}}" class="option-tag">轮廓</text>
                  <text wx:if="{{questionnaire.questions[currentQuestionIndex].showNumbers}}" class="option-tag">数字</text>
                  <text wx:if="{{questionnaire.questions[currentQuestionIndex].showHands}}" class="option-tag">指针</text>
                </view>
              </view>
            </block>
            <block wx:elif="{{questionnaire.questions[currentQuestionIndex].subType === 'connect' || questionnaire.questions[currentQuestionIndex].subType === 'pattern' || questionnaire.questions[currentQuestionIndex].subType === '3d'}}">
              <view class="draw-prompt-container">
                <text class="prompt-title">提示句：</text>
                <text class="prompt-content">
                  {{questionnaire.questions[currentQuestionIndex].prompt || '请依照例图所示完成画图'}}
                </text>
              </view>
            </block>

            <!-- 显示示例图片 -->
            <block wx:if="{{questionnaire.questions[currentQuestionIndex].exampleImage}}">
              <text class="answer-label">上传例图：</text>
              <view class="example-image-container">
                <image
                  src="{{questionnaire.questions[currentQuestionIndex].exampleImage}}"
                  mode="aspectFit"
                  class="example-image"
                />
              </view>
            </block>
            
            <!-- 显示用户画图答案 -->
            <view class="drawing-preview-container">
              <text class="preview-title">用户画图答案：</text>
              <view class="drawing-preview">
                <canvas type="2d" id="drawCanvas" class="draw-canvas" hidden="{{showScoreCalculator}}"></canvas>
              </view>
            </view>
          </view>
        </view>

        <!-- 问答题 -->
        <view wx:elif="{{questionnaire.questions[currentQuestionIndex].type === 'text'}}">
          <view class="text-answer-container">
            <text class="answer-label">用户答案：</text>
            <text class="text-answer-content">{{questionnaire.questions[currentQuestionIndex].answer || '用户未填写答案'}}</text>
          </view>
        </view>

        <!-- 标签题 -->
        <view wx:elif="{{questionnaire.questions[currentQuestionIndex].type === 'label'}}">
          <view class="label-container">
            <text class="answer-label">用户标签答案：</text>
            <view class="label-list">
              <view wx:for="{{questionnaire.questions[currentQuestionIndex].labels}}" wx:key="index" class="label-item">
                {{item}}
              </view>
            </view>
          </view>
        </view>
      </view>
    </view>

    <!-- 操作按钮 -->
    <view class="buttons">
      <!-- 得分输入 -->
      <view class="row-buttons score-input-row">
        <view class="score-input-container">
          <text class="score-label">题目得分：</text>
          <input class="score-input" type="digit" value="{{questionScore}}" bindinput="onScoreInput" placeholder="请输入得分" disabled="{{submitted || judgeComplete || questionnaire.status === '已批阅'}}"/>
          <text class="score-unit">分</text>
        </view>
      </view>
      
      <view class="row-buttons same-size-buttons">
        <button class="btn-prev" bindtap="prevQuestion" disabled="{{currentQuestionIndex === 0}}">上一题</button>
        <button class="btn-next" bindtap="nextQuestion" disabled="{{currentQuestionIndex === questionnaire.questions.length - 1}}">下一题</button>
        <button class="btn-select" bindtap="showQuestionSelector">选题</button>
      </view>
      <view class="row-buttons finish-select same-size-buttons">
        <button class="btn-calculate" bindtap="calculateScore">计算得分</button>
        <button class="btn-save" bindtap="saveJudging">保存批阅</button>
        <button class="btn-submit" bindtap="completeJudging" disabled="{{judgeComplete || questionnaire.status === '已批阅'}}">
          {{judgeComplete || questionnaire.status === '已批阅' ? '已完成批阅' : '完成批阅'}}
        </button>
      </view>
      <view class="user-meta" style="margin-top: 16rpx;">
        <text>作答用户：{{questionnaire.userNickname || '未知'}}（{{questionnaire.userEmail || '未知'}}）</text>
        <text style="margin-left: 12rpx;">批阅用户：{{questionnaire.judgedByNickname || '未批阅'}}（{{questionnaire.judgedByEmail || '—'}}）</text>
      </view>
    </view>
  </view>
</view>